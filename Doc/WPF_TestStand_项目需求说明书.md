# WPF 测试执行软件（TestStand替代方案）项目需求说明书

## 1. 项目概述

### 1.1 项目背景

本项目旨在开发一个基于WPF（Windows Presentation Foundation）的测试执行管理软件，提供与NI TestStand类似的功能。该软件将用于工业自动化测试领域，支持测试序列的创建、编辑、执行和管理，适用于生产线测试、产品验证等场景。

### 1.2 项目目标

- 开发一个功能完善的测试执行平台，替代TestStand
- 提供直观的用户界面，降低学习成本
- 支持灵活的测试序列配置和扩展
- 确保系统的稳定性、可靠性和可维护性
- 支持多种测试设备和仪器的集成

### 1.3 目标用户

- 测试工程师：编写和调试测试序列
- 产线操作员：运行测试、查看结果
- 系统管理员：管理用户权限、系统配置
- 开发工程师：开发自定义测试模块

---

## 2. 功能需求

### 2.1 测试序列管理

#### 2.1.1 序列编辑器

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 可视化序列编辑 | 通过拖拽方式创建和编辑测试序列 | P0 |
| 步骤类型支持 | 支持数值测试、字符串测试、Pass/Fail测试、Action等步骤类型 | P0 |
| 流程控制 | 支持For循环、While循环、条件分支、子序列调用等 | P0 |
| 参数配置 | 可视化配置测试步骤的参数、限值、超时时间等 | P0 |
| 序列变量 | 支持局部变量、序列变量、全局变量三级作用域 | P0 |
| 步骤组 | 支持将多个步骤组织成组，便于管理 | P1 |
| 导入/导出 | 支持序列配置的导入导出（XML格式） | P1 |
| 版本控制 | 记录序列的修改历史，支持版本回滚 | P2 |

#### 2.1.2 测试步骤类型

| 步骤类型 | 描述 | 功能要求 |
|----------|------|----------|
| NumericTest | 数值测试 | 测量结果与上下限比较，支持公差范围 |
| StringTest | 字符串测试 | 测试结果与期望字符串匹配 |
| PassFail | 布尔测试 | 返回Pass或Fail |
| Action | 动作执行 | 执行操作但不产生测试结果 |
| ForLoop | For循环 | 固定次数循环执行子步骤 |
| WhileLoop | While循环 | 条件满足时循环执行 |
| ForEachLoop | ForEach循环 | 遍历数组执行子步骤 |
| ConditionalBranch | 条件分支 | 根据条件选择执行分支 |
| SequenceGroup | 步骤组 | 组织多个步骤 |
| SubSequenceCall | 子序列调用 | 调用其他序列 |

#### 2.1.3 测试限值管理

- **上下限设置**：支持设置测试值的上限（Upper）和下限（Lower）
- **比较模式**：支持GELE（≥下限且≤上限）、GTLT（>下限且<上限）、EQ（等于）、NE（不等于）等模式
- **单位管理**：支持测量单位的定义和显示
- **精度控制**：支持小数位数的设置

### 2.2 测试执行引擎

#### 2.2.1 执行控制

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 同步/异步执行 | 支持同步阻塞执行和异步后台执行 | P0 |
| 暂停/恢复 | 运行过程中可暂停和恢复执行 | P0 |
| 停止/中断 | 强制停止当前测试执行 | P0 |
| 单步调试 | 逐步执行，便于调试 | P0 |
| 断点设置 | 在指定步骤设置断点 | P1 |
| 跳过步骤 | 临时跳过某些步骤执行 | P1 |
| 从指定步骤开始 | 从序列中间某步骤开始执行 | P1 |

#### 2.2.2 重试与错误处理

| 功能 | 描述 |
|------|------|
| 自动重试 | 步骤失败后自动重试，可配置重试次数 |
| 失败处理策略 | 继续执行(Continue)、终止(Abort)、跳转(GotoStep)、执行后处理(GotoPostCondition) |
| 超时控制 | 每个步骤可配置执行超时时间 |
| 异常捕获 | 捕获并记录测试方法抛出的异常 |

#### 2.2.3 执行上下文

- **产品信息传递**：自动传递当前测试产品对象
- **模块信息传递**：自动传递测试模块对象
- **上下文变量**：支持在步骤间传递自定义数据

### 2.3 用户界面

#### 2.3.1 主界面布局

```
┌────────────────────────────────────────────────────────────────┐
│  菜单栏 | 工具栏                                                │
├────────────┬───────────────────────────────────────────────────┤
│            │                                                   │
│  序列浏览器│           测试执行区                              │
│  (左侧面板)│     (序列编辑器/执行监控)                         │
│            │                                                   │
│  - 序列列表│                                                   │
│  - 步骤树  │                                                   │
│            │                                                   │
├────────────┴───────────────────────────────────────────────────┤
│  状态栏 | 进度条 | 当前步骤信息                                 │
├────────────────────────────────────────────────────────────────┤
│            测试结果区 / 日志输出区                             │
│  (显示测试数据、Pass/Fail状态、详细日志)                       │
└────────────────────────────────────────────────────────────────┘
```

#### 2.3.2 序列编辑视图

| 组件 | 功能 |
|------|------|
| 步骤树视图 | TreeView显示序列结构，支持拖拽排序 |
| 属性面板 | 显示和编辑选中步骤的属性 |
| 参数编辑器 | 配置步骤参数和限值 |
| 变量查看器 | 查看和编辑序列变量 |
| 代码视图 | 查看生成的XML配置（可选） |

#### 2.3.3 执行监控视图

| 组件 | 功能 |
|------|------|
| 执行进度 | 显示当前执行进度和预计剩余时间 |
| 当前步骤 | 高亮显示正在执行的步骤 |
| 结果列表 | 实时显示测试结果（序号、名称、限值、实际值、判定） |
| 统计信息 | Pass/Fail计数、良率、测试时长 |
| 工位显示 | 支持多工位独立显示（左工位、右工位等） |

#### 2.3.4 结果显示格式

| 列名 | 说明 |
|------|------|
| Order | 测试序号 |
| Name | 测试项名称 |
| LowLimit | 下限值 |
| UpperLimit | 上限值 |
| Value | 实际测试值 |
| Test | 测试结果（PASS/FAIL） |
| Unit | 测量单位 |
| Time | 测试耗时 |

### 2.4 测试方法注册与调用

#### 2.4.1 测试方法特性标记

```csharp
[TestMethod(Name = "电压测试", Description = "测量电源电压", Category = "电气测试")]
public double TestVoltage(int channel)
{
    // 测试逻辑
    return measuredVoltage;
}
```

#### 2.4.2 方法注册表

- **自动扫描**：启动时自动扫描标记有`[TestMethod]`特性的方法
- **动态加载**：支持运行时加载新的测试方法DLL
- **方法查询**：按类名、方法名、分类查询可用的测试方法
- **参数信息**：获取方法的参数类型和默认值

### 2.5 数据管理

#### 2.5.1 测试数据保存

| 功能 | 描述 | 优先级 |
|------|------|--------|
| CSV日志 | 测试结果保存为CSV文件 | P0 |
| 数据库存储 | 支持保存到SQLite/MySQL数据库 | P1 |
| 数据追溯 | 通过产品条码查询历史测试记录 | P1 |
| 数据导出 | 支持导出为Excel、PDF格式 | P2 |

#### 2.5.2 统计报表

- **UPH统计**：每小时产出统计
- **良率报表**：Pass/Fail统计和良率计算
- **SPC分析**：统计过程控制（可选）
- **趋势图表**：测试数据趋势可视化

### 2.6 硬件集成

#### 2.6.1 设备通信支持

| 通信类型 | 描述 |
|----------|------|
| 串口通信 | RS232/RS485通信 |
| TCP/IP | 以太网通信 |
| Modbus | Modbus RTU/TCP协议 |
| GPIB | IEEE-488仪器通信 |
| USB | USB设备通信 |

#### 2.6.2 常用设备支持

- 运动控制卡（雷赛、研华等）
- 相机（Basler、大恒等）
- 数字万用表
- 电源
- 扫码器
- IO控制板

### 2.7 用户权限管理

#### 2.7.1 权限级别

| 权限级别 | 描述 | 可用功能 |
|----------|------|----------|
| 操作员 | 生产操作人员 | 运行测试、查看结果 |
| 工程师 | 测试工程师 | 编辑序列、调试测试 |
| 管理员 | 系统管理员 | 所有功能、用户管理 |

#### 2.7.2 权限控制

- 登录认证
- 功能访问控制
- 操作日志记录
- 密码策略管理

### 2.8 安全功能

#### 2.8.1 设备安全

| 功能 | 描述 |
|------|------|
| 安全门检测 | 检测安全门状态，门开时禁止运行 |
| 光栅检测 | 安全光栅触发时暂停或停止 |
| 治具状态检测 | 检测治具关闭状态 |
| 急停处理 | 急停按钮处理 |

#### 2.8.2 数据安全

- 配置文件加密（可选）
- 操作审计日志
- 数据备份功能

---

## 3. 非功能需求

### 3.1 性能要求

| 指标 | 要求 |
|------|------|
| 启动时间 | ≤ 5秒 |
| 序列加载时间 | ≤ 1秒（1000步以内） |
| UI响应时间 | ≤ 100ms |
| 测试结果更新 | 实时（≤ 50ms延迟） |
| 内存占用 | ≤ 500MB（正常运行） |

### 3.2 可靠性要求

- 7x24小时稳定运行
- 异常崩溃自动恢复
- 测试数据不丢失
- 关键操作事务保护

### 3.3 可维护性要求

- 模块化架构设计
- 详细的日志记录
- 配置文件易于理解和修改
- 完善的错误提示信息

### 3.4 可扩展性要求

- 插件式测试方法扩展
- 支持自定义步骤类型
- 支持第三方设备驱动集成
- 多语言界面支持（中文、英文）

### 3.5 兼容性要求

- 操作系统：Windows 10/11（64位）
- .NET Framework：4.8 或 .NET 6+
- 分辨率：支持1920x1080及以上
- 多显示器：支持

---

## 4. 技术架构

### 4.1 总体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         表现层 (Presentation Layer)             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │   主界面     │  │  序列编辑器  │  │  结果视图    │          │
│  │  (WPF/MVVM) │  │  (WPF/MVVM) │  │  (WPF/MVVM) │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
├─────────────────────────────────────────────────────────────────┤
│                         业务逻辑层 (Business Logic Layer)       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ 序列执行引擎 │  │ 测试方法注册 │  │  数据管理    │          │
│  │SequenceExecutor│ │ MethodRegistry│ │ DataManager │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
├─────────────────────────────────────────────────────────────────┤
│                         数据访问层 (Data Access Layer)          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ 配置加载器   │  │  数据库访问  │  │  文件存储    │          │
│  │ConfigLoader  │  │  DbContext   │  │  FileStore   │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
├─────────────────────────────────────────────────────────────────┤
│                         硬件抽象层 (Hardware Abstraction Layer) │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  通信接口    │  │  设备驱动    │  │  IO控制      │          │
│  │Communication │  │  DeviceDriver│  │  IOControl   │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 核心模块

| 模块名称 | 职责 | 关键类 |
|----------|------|--------|
| TestSequence | 测试序列定义和管理 | TestSequence, TestStep, TestLimits |
| SequenceExecutor | 序列执行引擎 | SequenceExecutor, StepExecutionEventArgs |
| MethodRegistry | 测试方法注册和调用 | TestMethodRegistry, RegisteredTestMethod |
| ConfigLoader | 配置文件加载和验证 | SequenceConfigLoader, SequenceConfigValidator |
| UIController | 界面控制和数据绑定 | MainViewModel, SequenceEditorViewModel |
| DataManager | 数据存储和查询 | TestResultManager, StatisticsManager |
| HardwareManager | 硬件设备管理 | DeviceManager, CommunicationManager |

### 4.3 设计模式

- **MVVM模式**：WPF界面与业务逻辑分离
- **单例模式**：测试方法注册表、应用程序实例
- **工厂模式**：测试步骤创建
- **观察者模式**：事件通知机制
- **策略模式**：失败处理策略

---

## 5. 项目计划

### 5.1 开发阶段

| 阶段 | 时间 | 主要交付物 |
|------|------|------------|
| 需求分析 | 2周 | 需求规格说明书 |
| 架构设计 | 2周 | 架构设计文档、接口定义 |
| 核心开发 | 8周 | 执行引擎、序列编辑器、基础UI |
| 功能完善 | 4周 | 数据管理、报表、权限管理 |
| 集成测试 | 2周 | 测试报告、Bug修复 |
| 用户验收 | 2周 | 用户手册、培训文档 |

### 5.2 里程碑

| 里程碑 | 时间点 | 验收标准 |
|--------|--------|----------|
| M1-原型演示 | 第4周 | 基础UI框架、序列加载执行 |
| M2-核心功能 | 第10周 | 完整执行引擎、序列编辑 |
| M3-功能完整 | 第16周 | 所有P0/P1功能完成 |
| M4-正式发布 | 第20周 | 通过验收测试 |

---

## 6. 附录

### 6.1 参考现有实现

本项目可参考现有代码库中的TestSequence模块实现，主要文件包括：

- `Logic/TestSequence/TestSequence.cs` - 测试序列定义
- `Logic/TestSequence/TestStep.cs` - 测试步骤定义
- `Logic/TestSequence/SequenceExecutor.cs` - 序列执行引擎
- `Logic/TestSequence/TestMethodRegistry.cs` - 测试方法注册表
- `Logic/TestSequence/Config/SequenceConfigLoader.cs` - 配置加载器
- `Logic/TestSequence/Config/SequenceConfigValidator.cs` - 配置验证器

### 6.2 术语表

| 术语 | 定义 |
|------|------|
| TestStand | NI公司的测试执行管理软件 |
| Sequence | 测试序列，包含一系列测试步骤 |
| Step | 测试步骤，执行单个测试操作 |
| Limits | 测试限值，定义Pass/Fail判定标准 |
| UPH | Units Per Hour，每小时产出 |
| SPC | Statistical Process Control，统计过程控制 |

### 6.3 版本历史

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|----------|
| 1.0 | 2024-12-05 | - | 初始版本 |

---

## 7. 批准

| 角色 | 姓名 | 签名 | 日期 |
|------|------|------|------|
| 项目经理 | | | |
| 技术负责人 | | | |
| 产品经理 | | | |
