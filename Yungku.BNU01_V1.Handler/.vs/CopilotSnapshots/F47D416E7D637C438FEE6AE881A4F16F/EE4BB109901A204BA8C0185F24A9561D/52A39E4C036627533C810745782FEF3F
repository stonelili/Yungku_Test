using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using System.Diagnostics;
using System.Threading;
using YungkuSystem.Machine;
using YungkuSystem;
using YungkuSystem.Log;
using YungkuSystem.Statistical;
using YungkuSystem.Controls;
using Yungku.BNU01_V1.Handler.Logic.Objects;
using YungkuSystem.Globalization;
using YungkuSystem.TestFlow;
using Yungku.BNU01_V1.Handler.Config;
using YungkuSystem.AlarmManage;
using YungkuSystem.Tray;
using YungkuSystem.ThreadMessage;
using LiveCharts.Wpf;
using LiveCharts;
using YungkuSystem.YKControls.ykProcess;
using YungkuSystem.Structs;
using YungkuSystem.ExternalControl.StatisticalForm;
using YungkuSystem.Tester;

namespace Yungku.BNU01_V1.Handler.Pages
{
    public partial class FormAuto : Form
    {
        private ListViewLogView listViewLogView = null;
        private Form frm;
        private ProductObject product = MyApp.GetInstance().Machine.TestItems[0].TestItems[0].TestItems[0].TestItems[0].BindingObject as ProductObject;

        public FormAuto()
        {
            InitializeComponent();
        }

        private void FormAuto_Load(object sender, EventArgs e)
        {
            listViewLogView = new ListViewLogView(lvLog);
            LogPublisher lp = (LogPublisher)MyApp.GetInstance().FW.LogService.CreateLogPublisher(Framework.KEY);
            lp.AddLogWriter(listViewLogView);
            lp.ContinuePublish();

            MyApp.GetInstance().AlarmPublisher.AlarmListChanged += AlarmPublisher_AlarmListChanged;
            MyApp.GetInstance().AlarmPublisher.AddAlarmWriter(new ListViewAlarmView(lvAlarms));
            //根据产品数量更新界面
            int productCount = MyApp.GetInstance().Machine.ProductCount;
            yieldGroup1.Count = productCount;
            labelGroup2.Count = (MyApp.GetInstance().Machine.TestItems[0] as Turntable).Stations.Count;
            Control.CheckForIllegalCrossThreadCalls = false;
            statisticalState1.Statis = MyApp.GetInstance().Statistical;

            InitClient();//软件开启建立连接
        }

        private void AlarmPublisher_AlarmListChanged(object sender, Alarm e)
        {
            MyApp.RunOnUI(new System.Action(() =>
            {
                //转到报警列表
                if (MyApp.GetInstance().AlarmPublisher.IsAlarm)
                {
                    ykTabLog.SelectedIndex = 1;//Alarms view
                }
                else
                {
                    ykTabLog.SelectedIndex = 0;//Log view
                }
            }));
        }

        private void tmrUpdateUI_Tick(object sender, EventArgs e)
        {
            if (this.Visible)
            {
                lblProductName.Text = G.Text(MyApp.Config.General.ProductName);
                ShowYield();

                int dogLiveDays = MyApp.SuperDog.GetDaysLeft();
                if (dogLiveDays == 365)
                {
                    lblSuperDogLiveDays.Visible = false;
                }
                else
                {
                    lblSuperDogLiveDays.Visible = true;
                    lblSuperDogLiveDays.Text = G.Text("加密狗剩余：" + dogLiveDays + "天");
                }
                UpdataTimeText();
            }
        }

        private void UpdataTimeText()
        {
            double tepCount;
            double avgCount;
            foreach (Turntable tt in MyApp.GetInstance().Machine.TestItems)//turntables
            {
                for (int i = 0; i < tt.Stations.Count; i++)
                {
                    tepCount = tt.Stations[i].Executor.Actions.Root.ExecutedAllTimes;
                    avgCount = tt.Stations[i].Executor.Actions.Root.ExecutedAgvTimes;
                    if (tepCount != -1 && avgCount != -1)
                    {
                        string stateStr = (tepCount / 1000).ToString("0") + "[Avg:" + (avgCount / 1000).ToString("0") + "]" + "ms" + "\r\n";
                        stateStr += tt.Stations[i].Name + "\\" + tt.Stations[i].Executor.CurrentStateIndex;
                        labelGroup2.LabelControls[i].Text = stateStr;
                    }
                }
            }

        }

        private void ShowYield()
        {
            IStatistical statis = MyApp.GetInstance().Statistical;
            //获取机台上所有治具的名称
            List<string> names = GetProductNames();
            for (int i = 0; i < names.Count; i++)
            {
                string name = names[i];
                int passCount = statis.GetPassByJig(name);
                int failCount = statis.GetFailByItemName(name);
                int total = passCount + failCount;
                double yield = total == 0 ? 1 : (passCount * 1.0 / total);
                if (i < yieldGroup1.YieldControls.Count)
                {
                    YKProgressBar control = yieldGroup1.YieldControls[i];
                    control.Caption = name;
                    control.Value = yield;
                }

            }
        }

        private List<string> GetProductNames()
        {
            return ProductObject.GetNames(MyApp.GetInstance().Machine);
        }

        private void FormAuto_VisibleChanged(object sender, EventArgs e)
        {
            if (this.Visible)
            {
                MyApp.GetInstance().Logger.WriteRecord(G.Text("切换到自动画面"));

            }
        }

        private FormDetail fd = new FormDetail();
        private void yieldGroup1_DoubleClick(object sender, EventArgs e)
        {
            if (MyApp.GetInstance().Statistical != null && MyApp.GetInstance().Statistical is StatisticalDefaultImpl)
                fd.Statistical = MyApp.GetInstance().Statistical as StatisticalDefaultImpl;
            if (!fd.Visible)
                fd.Show();
        }

        private void 显示统计信息ToolStripMenuItem_Click(object sender, EventArgs e)
        {
            if (MyApp.GetInstance().Statistical != null && MyApp.GetInstance().Statistical is StatisticalDefaultImpl)
                fd.Statistical = MyApp.GetInstance().Statistical as StatisticalDefaultImpl;
            if (!fd.Visible)
                fd.Show();
        }

        private void 显示不良明细ToolStripMenuItem_Click(object sender, EventArgs e)
        {
            if (MyApp.GetInstance().Statistical != null && MyApp.GetInstance().Statistical is StatisticalDefaultImpl)
                fd.Statistical = MyApp.GetInstance().Statistical as StatisticalDefaultImpl;
            if (!fd.Visible)
                fd.Show();
        }

        private void nG代码管理ToolStripMenuItem_Click(object sender, EventArgs e)
        {
            MyApp.GetInstance().Statistical.GetCodeNameEditor().Show();
        }

        private void tsmiClearLogs_Click(object sender, EventArgs e)
        {
            lvLog.Items.Clear();
        }

        private void tsmiSelectLogs_Click(object sender, EventArgs e)
        {
            FormLogViewQuery frm = new FormLogViewQuery();
            frm.Show();
        }

        private void 当前另存为ToolStripMenuItem_Click(object sender, EventArgs e)
        {
            listViewLogView.CurrentSaveAs();
        }

        private void FormAuto_Paint(object sender, PaintEventArgs e)
        {
            Rectangle rect = new Rectangle(this.ClientRectangle.X, this.ClientRectangle.Y, this.ClientRectangle.Width - 1, this.ClientRectangle.Height - 1);
            SolidBrush br = new SolidBrush(this.BackColor);
            e.Graphics.FillRectangle(br, rect);
            br.Dispose();
            e.Graphics.DrawRectangle(Pens.Blue, rect);
        }

        private void FormAuto_SizeChanged(object sender, EventArgs e)
        {
            this.Refresh();
        }

        private void FormAuto_Resize(object sender, EventArgs e)
        {
            splitfunction.SplitterDistance = 357;
        }

        private void toolStripMenuItem2_Click(object sender, EventArgs e)
        {
            if (MessageBox.Show(G.Text("确定清除统计数据吗？"), G.Text("清楚统计数据"),
             MessageBoxButtons.YesNo, MessageBoxIcon.Question) == System.Windows.Forms.DialogResult.Yes)
            {
                if (MyApp.GetInstance().Statistical != null)
                {
                    MyApp.GetInstance().Statistical.Clear();
                }
            }
        }

        //双击连接线体
        private void ledTestConnect_DoubleClick(object sender, EventArgs e)
        {
            MyApp.RunOnUIThread(new Action(() =>
            {
                try
                {
                    InitClient();
                    Tip.ShowWarning(G.Text("正在重连"));
                }
                catch (Exception ex)
                {
                    Tip.ShowError(G.Text($"重连失败: {ex.Message}"));
                    MyApp.GetInstance().Logger.WriteError($"重连客户端失败: {ex}");
                }
            }));
        }

        private void tmrConnect_Tick(object sender, EventArgs e)
        {
            if (this.Visible)
            {
                this.tmrConnect.Enabled = false;
                if (MyApp.GetInstance().TestSoftwareClient.RealConnectionState == YungkuSystem.Tester.ConnectionState.Connected)
                {
                    ledTestConnect.State = true;
                    lblledTestConnect_C.BackColor = System.Drawing.Color.FromArgb(((int)(((byte)(50)))), ((int)(((byte)(50)))), ((int)(((byte)(50)))));
                    lblledTestConnect_E.BackColor = System.Drawing.Color.FromArgb(((int)(((byte)(50)))), ((int)(((byte)(50)))), ((int)(((byte)(50)))));
                }
                else
                {
                    ledTestConnect.State = false;
                    lblledTestConnect_C.BackColor = Color.Red;
                    lblledTestConnect_E.BackColor = Color.Red;
                }
                this.tmrConnect.Enabled = true;
            }
        }

        public void InitClient()
        {
            MyApp.GetInstance().TestSoftwareClient = product.TestClient;

            if (MyApp.GetInstance().TestSoftwareClient.RealConnectionState != YungkuSystem.Tester.ConnectionState.Connected)
            {
                MyApp.GetInstance().TestSoftwareClient.Uinit();
                Thread.Sleep(100);
                MyApp.GetInstance().TestSoftwareClient.Init();
            }
            MyApp.GetInstance().TestSoftwareClient.OnReceiveCompleted += Client_OnReceiveCompleted;//完成接收 
        }

        private void Client_OnReceiveCompleted(object sender, SocketDatagramReceivedEventArgs<Dictionary<string, string>> e)
        {
            Dictionary<string, string> data = e.Datagram;
            MyApp.GetInstance().CurrentCMD = data["Product0"].ToString(); ;
        }

        private void tmrAutoConnect_Tick(object sender, EventArgs e)
        {
            AutoConnect();
        }

        private void AutoConnect()
        {
            if (MyApp.GetInstance().TestSoftwareClient.RealConnectionState != YungkuSystem.Tester.ConnectionState.Connected)
            {
                MyApp.GetInstance().TestSoftwareClient.Uinit();
                Thread.Sleep(100);
                MyApp.GetInstance().TestSoftwareClient.Init();
                MyApp.GetInstance().TestSoftwareClient.OnReceiveCompleted -= Client_OnReceiveCompleted;
                MyApp.GetInstance().TestSoftwareClient.OnReceiveCompleted += Client_OnReceiveCompleted;//完成接收                 
            }
        }
    }
}
