using System;
using System.Collections.Generic;
using System.Drawing;
using System.IO;
using System.Runtime.InteropServices;
using System.Text;
using System.Threading.Tasks;
using Yungku.BNU01_V1.Handler.Config;
using Yungku.BNU01_V1.Handler.Logic.Actions;
using Yungku.BNU01_V1.Handler.Logic.Objects;
using Yungku.BNU01_V1.Handler.Pages;
using YungkuSystem.Controls;
using YungkuSystem.Globalization;
using YungkuSystem.Machine;
using YungkuSystem.Statistical;
using YungkuSystem.Tester;
using YungkuSystem.TestFlow;
using YungkuSystem.ThreadMessage;

namespace Yungku.BNU01_V1.Handler.Logic
{
    internal class ActionMain : LogicObject
    {
        private Product prod = null;
        private ProductObject prodObj
        {
            get
            {
                if (prod != null)
                {
                    return prod.BindingObject as ProductObject;
                }
                return null;
            }
        }
        private IModuleGroup curTestClient = null;

        public ActionMain()
        {
            this.Name = "主控流程";

            try
            {
                // 正确的 Machine 层次结构（根据 MyApp.Initialize 中的初始化结果弹窗代码）：
                // machine.TestItems[0].TestItems[0].TestItems[0].TestItems.Count
                // 表示：Machine → TestItems[0] (Turntable) → TestItems[0] (Head?) → TestItems[0] (Jig?) → TestItems[0] (Product)

                if (MyApp.GetInstance()?.Machine?.TestItems != null &&
          MyApp.GetInstance().Machine.TestItems.Count > 0)
                {
                    // 获取第一个 Turntable
                    Turntable turntable = MyApp.GetInstance().Machine.TestItems[0] as Turntable;

                    if (turntable?.Stations != null && turntable.Stations.Count > 0)
                    {
                        // 获取第一个 Station
                        Station station = turntable.Stations[0];

                        // 尝试从 Turntable.TestItems 获取 Head（因为初始化结果弹窗代码使用 Machine.TestItems[0].TestItems[0]...）
                        if (turntable.TestItems != null && turntable.TestItems.Count > 0)
                        {
                            // 获取第一个 Head
                            Head head = turntable.TestItems[0] as Head;

                            if (head?.TestItems != null && head.TestItems.Count > 0)
                            {
                                // 获取第一个 Jig
                                Jig jig = head.TestItems[0] as Jig;

                                if (jig?.TestItems != null && jig.TestItems.Count > 0)
                                {
                                    // 获取第一个 Product
                                    prod = jig.TestItems[0] as Product;

                                    if (prod != null)
                                    {
                                        // 安全获取 prodObj 和 curTestClient
                                        var productObj = prod.BindingObject as ProductObject;
                                        if (productObj != null)
                                        {
                                            curTestClient = productObj.TestClient;
                                            MyApp.GetInstance()?.Logger?.WriteRecord($"[ActionMain构造]:成功初始化 - Product:{prod.Name}");
                                        }
                                        else
                                        {
                                            MyApp.GetInstance()?.Logger?.WriteError("[ActionMain构造]:Product.BindingObject 不是 ProductObject 类型");
                                        }
                                    }
                                    else
                                    {
                                        MyApp.GetInstance()?.Logger?.WriteError("[ActionMain构造]:Jig.TestItems[0] 不是 Product 类型");
                                    }
                                }
                                else
                                {
                                    MyApp.GetInstance()?.Logger?.WriteError("[ActionMain构造]:Jig.TestItems 为空或数量不足");
                                }
                            }
                            else
                            {
                                MyApp.GetInstance()?.Logger?.WriteError("[ActionMain构造]:Head.TestItems 为空或数量不足");
                            }
                        }
                        else
                        {
                            MyApp.GetInstance()?.Logger?.WriteError("[ActionMain构造]:Turntable.TestItems 为空或数量不足");
                        }
                    }
                    else
                    {
                        MyApp.GetInstance()?.Logger?.WriteError("[ActionMain构造]:Turntable.Stations 为空或数量不足");
                    }
                }
                else
                {
                    MyApp.GetInstance()?.Logger?.WriteError("[ActionMain构造]:Machine.TestItems (Turntable) 为空");
                }
            }
            catch (Exception ex)
            {
                MyApp.GetInstance()?.Logger?.WriteError($"[ActionMain构造]:初始化异常 - {ex.Message}\n堆栈：{ex.StackTrace}");
            }
        }

        private IModuleGroup GetTestClient()
        {
            if (curTestClient == null && prodObj != null)
            {
                curTestClient = prodObj.TestClient;
            }
            return curTestClient;
        }
        protected override void OnException(Exception ex)
        {
            OnAlarm(G.Text("主流程异常，设备需要复位！"));
            OnAlarm(G.Text(ex.Message));
        }

        /// <summary>
        /// 主流程
        /// </summary>
        protected override void Handle()
        {
            if (MyApp.NeedReset || MyApp.ShareData.ishoming)
            {
                OnAlarm(G.Text("设备未复位或者在回原状态中，请检查！"));
                return;
            }
            try
            {
                switch (StateIndex)
                {
                    case ActionBase.ACT_STATE_START:
                        #region
                        Watcher.StopAllWatch();
                        CurrentHeadObject.SetModudeState(true);
                        prod.State = TestState.Testing;
                        RestProdutCode();

                        // 清空上一次测试的数据显示
                        TestDisplayHelper.ClearAllStations();
                        TestDisplayHelper.ResetCounters();

                        To("启动Station测试");
                        #endregion
                        break;

                    case "启动Station测试":
                        #region
                        //启动 Station 测试并显示初始状态
                        StartAllStationTestsWithDisplay();

                        To("等待测试完成");
                        #endregion
                        break;

                    case "等待测试完成":
                        #region
                        // 等待所有 Station 测试完成
                        if (WaitAllStationTestsComplete())
                        {
                            WriteRecord("所有测试完成");

                            //更新最终测试结果到界面
                            UpdateTestResultsToDisplay();

                            To("保存测试数据");
                        }
                        #endregion
                        break;

                    case "保存测试数据":
                        #region
                        WriteRecord("测试完成");
                        To(ActionBase.ACT_STATE_END);
                        Watcher.StopWatch(StateIndex);
                        #endregion
                        break;

                    case ActionBase.ACT_STATE_END:
                        #region
                        Finish();
                        #endregion
                        break;
                }
            }
            catch (Exception ex)
            {
                Logger.WriteError(string.Format("{0}-{1}Exception:{2}", this.Name, StateIndex, ex.Message));
            }
        }

        /// <summary>
        /// 启动所有 Station 的测试并显示初始状态
        /// </summary>
        private void StartAllStationTestsWithDisplay()
        {
            try
            {
                WriteRecord("========================================");
                WriteRecord(string.Format("🚀 开始启动所有工位测试，共 {0} 个工位", Turntable.Stations.Count));
                WriteRecord("========================================");

                //第一步：诊断所有Station配置
                WriteRecord("📋 【诊断】开始检查所有Station配置...");
                for (int i = 0; i < Turntable.Stations.Count; i++)
                {
                    Station station = Turntable.Stations[i];
                    string stationName = i == 0 ? "左工位" : "右工位";

                    WriteRecord(string.Format(""));
                    WriteRecord(string.Format("📍 【诊断】{0} (Station{1}):", stationName, i));
                    WriteRecord(string.Format("   ├─ Name: {0}", station.Name));
                    WriteRecord(string.Format(" ├─ Enabled: {0}", station.Enabled ? "✓ 是" : "❌ 否"));

                    if (!station.Enabled)
                    {
                        WriteRecord(string.Format("   └─ ⚠ {0} 未启用，将跳过测试", stationName));
                        continue;
                    }

                    // 检查 Executor
                    if (station.Executor == null)
                    {
                        WriteRecord(string.Format("   ├─ Executor: ❌ NULL"));
                        WriteRecord(string.Format("   └─ 🚨 严重错误：Executor 未初始化！"));
                        continue;
                    }
                    WriteRecord(string.Format("   ├─ Executor: ✓ 已初始化"));

                    // 检查 Actions
                    if (station.Executor.Actions.Root == null)
                    {
                        WriteRecord(string.Format("   ├─ Actions.Root: ❌ NULL"));
                        WriteRecord(string.Format(" └─ 🚨 严重错误：Actions.Root 未初始化！"));
                        continue;
                    }
                    WriteRecord(string.Format("   ├─ Actions.Root: ✓ 已初始化"));

                    int actionCount = station.Executor.Actions.Root.Childs.Count;
                    WriteRecord(string.Format("   ├─ Actions数量: {0}", actionCount));

                    if (actionCount == 0)
                    {
                        WriteRecord(string.Format("   └─ 🚨 严重警告：{0} 没有配置任何测试脚本！", stationName));
                    }
                    else
                    {
                        WriteRecord(string.Format("   └─ Actions列表:"));
                        for (int j = 0; j < Math.Min(actionCount, 10); j++)
                        {
                            var action = station.Executor.Actions.Root.Childs[j];
                            string actionType = action.GetType().Name;
                            bool isImportant = actionType.Contains("Test") || actionType.Contains("Calculator");
                            string icon = isImportant ? "🔸" : "○";

                            WriteRecord(string.Format("    {0} [{1}] {2} ({3})", icon, j, action.Name, actionType));
                        }

                        if (actionCount > 10)
                        {
                            WriteRecord(string.Format("... 还有 {0} 个Action", actionCount - 10));
                        }
                    }
                }

                WriteRecord("========================================");
                WriteRecord("📋 【诊断】配置检查完成");
                WriteRecord("========================================");

                // ❌ 移除第二步：不再为工位显示初始状态（"准备启动测试..."）

                //第三步：同时启动所有工位的测试脚本
                List<Station> startedStations = new List<Station>();

                foreach (Station station in Turntable.Stations)
                {
                    if (!station.Enabled)
                    {
                        WriteRecord(string.Format("⏭ 跳过未启用的工位"));
                        continue;
                    }

                    int stationIndex = Turntable.Stations.IndexOf(station);
                    string stationName = stationIndex == 0 ? "左工位" : "右工位";

                    try
                    {
                        WriteRecord(string.Format("📋 【{0}】 准备启动测试脚本...", stationName));

                        //直接启动测试脚本
                        if (station.Executor != null && station.Executor.Actions.Root != null)
                        {
                            // 确保之前的测试已停止
                            if (station.Executor.IsRunning)
                            {
                                WriteRecord(string.Format("⚠ {0} 正在运行，先停止", stationName));
                                station.Executor.Stop();
                                System.Threading.Thread.Sleep(100);
                            }

                            // 启动测试
                            WriteRecord(string.Format("🎬 启动 {0} 测试脚本...", stationName));
                            station.Executor.Run(0, station.Name);
                            startedStations.Add(station);

                            WriteRecord(string.Format("✅ {0} 测试脚本已启动", stationName));

                            // ❌ 移除：不再显示"测试中..."状态
                        }
                        else
                        {
                            if (station.Executor == null)
                            {
                                WriteRecord(string.Format("❌ {0} Executor 为 null，无法启动测试！", stationName));
                            }
                            else if (station.Executor.Actions.Root == null)
                            {
                                WriteRecord(string.Format("❌ {0} Actions.Root 为 null，无法启动测试！", stationName));
                            }
                        }
                    }
                    catch (Exception ex)
                    {
                        Logger.WriteError(string.Format("❌ 启动{0}测试失败: {1}", stationName, ex.Message));
                        Logger.WriteError(string.Format("异常堆栈: {0}", ex.StackTrace));

                        // ❌ 移除：不再显示错误状态到界面
                    }
                }

                WriteRecord(string.Format("🏁 所有测试脚本已启动，共 {0} 个工位", startedStations.Count));
                WriteRecord("========================================");

                // 如果右工位没有启动，给出详细提示
                if (Turntable.Stations.Count >= 2 && !startedStations.Contains(Turntable.Stations[1]))
                {
                    WriteRecord("");
                    WriteRecord("========================================");
                    WriteRecord("🚨 【问题诊断】右工位未成功启动测试");
                    WriteRecord("========================================");

                    Station rightStation = Turntable.Stations[1];

                    if (!rightStation.Enabled)
                    {
                        WriteRecord("原因：右工位未启用");
                        WriteRecord("解决方案：");
                        WriteRecord("  1. 打开【系统设置】→【测试设备配置】");
                        WriteRecord("  2. 找到 Station1（右工位）");
                        WriteRecord("  3. 勾选【启用】复选框");
                        WriteRecord("  4. 保存配置并重启程序");
                    }
                    else if (rightStation.Executor == null)
                    {
                        WriteRecord("原因：右工位 Executor 未初始化");
                        WriteRecord("解决方案：请联系技术支持，这是系统配置问题");
                    }
                    else if (rightStation.Executor.Actions.Root == null)
                    {
                        WriteRecord("原因：右工位 Actions.Root 未初始化");
                        WriteRecord("解决方案：请联系技术支持，这是系统配置问题");
                    }
                    else if (rightStation.Executor.Actions.Root.Childs.Count == 0)
                    {
                        WriteRecord("原因：右工位没有配置任何测试脚本（Actions数量为0）");
                        WriteRecord("解决方案：");
                        WriteRecord("  1. 打开【系统设置】→【参数配置】→【BNU01设置】");
                        WriteRecord("  2. 展开【源式设备】→【转盘(Turntable0)】→【站位(Station0)】");
                        WriteRecord("  3. 复制 Station0 的所有 Action");
                        WriteRecord("  4. 展开【源式设备】→【转盘(Turntable0)】→【站位(Station1)】");
                        WriteRecord("5. 粘贴到 Station1");
                        WriteRecord("  6. 保存配置并重启程序");
                        WriteRecord("");
                        WriteRecord("提示：Station0（左工位）的 Actions 列表：");

                        Station leftStation = Turntable.Stations[0];
                        if (leftStation.Executor?.Actions.Root != null)
                        {
                            for (int i = 0; i < Math.Min(leftStation.Executor.Actions.Root.Childs.Count, 10); i++)
                            {
                                var action = leftStation.Executor.Actions.Root.Childs[i];
                                WriteRecord(string.Format("      [{0}] {1} ({2})", i, action.Name, action.GetType().Name));
                            }
                        }
                    }

                    WriteRecord("========================================");
                    WriteRecord("");
                }
            }
            catch (Exception ex)
            {
                Logger.WriteError(string.Format("启动测试失败: {0}", ex.Message));
                Logger.WriteError(string.Format("异常堆栈: {0}", ex.StackTrace));
            }
        }

        /// <summary>
        /// 等待所有 Station 测试完成
        /// </summary>
        private bool WaitAllStationTestsComplete()
        {
            bool allComplete = true;
            int runningCount = 0;
            int completedCount = 0;

            foreach (Station station in Turntable.Stations)
            {
                if (!station.Enabled)
                    continue;

                // 检查 Station 是否还在运行
                if (station.Executor.IsRunning)
                {
                    allComplete = false;
                    runningCount++;
                }
                else
                {
                    completedCount++;
                }
            }

            return allComplete;
        }

        /// <summary>
        /// 产品置位良品
        /// </summary>
        public void RestProdutCode()
        {
            foreach (Jig jig in CurrentHead.TestItems)
            {
                foreach (Product product in jig.TestItems)
                {
                    if (product.Result != TestResult.Closed)
                        product.Result = CurrentHeadObject.HasModudeState ? TestResult.Pass : TestResult.Empty;
                    product.ResultCode = "00";
                }
            }
        }

        /// <summary>
        /// 更新测试结果到界面显示
        /// </summary>
        private void UpdateTestResultsToDisplay()
        {
            try
            {
                // 遍历所有 Station，获取测试结果
                for (int stationIndex = 0; stationIndex < Turntable.Stations.Count; stationIndex++)
                {
                    Station station = Turntable.Stations[stationIndex];
                    if (!station.Enabled)
                        continue;

                    // 获取该 Station 的所有产品测试结果
                    Head head = Turntable.GetHeadByStation(station);
                    if (head != null)
                    {
                        foreach (Jig jig in head.TestItems)
                        {
                            foreach (Product product in jig.TestItems)
                            {
                                ProductObject prodObj = product.BindingObject as ProductObject;
                                if (prodObj != null && prodObj.OwnerEnabled)
                                {
                                    string testName = product.Name;
                                    string result = product.Result == TestResult.Pass ? "PASS" :
                                               product.Result == TestResult.Fail ? string.Format("FAIL ({0})", product.ResultCode) :
                                              product.Result.ToString();

                                    // 根据 Station 索引判断是左工位还是右工位
                                    if (stationIndex == 0)
                                    {
                                        TestDisplayHelper.UpdateLeftStation(testName, result);
                                    }
                                    else if (stationIndex == 1)
                                    {
                                        TestDisplayHelper.UpdateRightStation(testName, result);
                                    }

                                    string stationName = stationIndex == 0 ? "左工位" : "右工位";
                                    WriteRecord(string.Format("[{0}] {1}: {2}", stationName, testName, result));
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Logger.WriteError(string.Format("更新测试结果到界面失败: {0}", ex.Message));
            }
        }
    }
}