using System;
using System.Drawing;
using System.Windows.Forms;
using YungkuSystem.Globalization;

namespace Yungku.BNU01_V1.Handler.Pages
{
    /// <summary>
    /// FormAuto的统计功能扩展部分
    /// </summary>
    public partial class FormAuto
    {
        // 左右工位统计数据
        private int leftStationTotal = 0;
        private int leftStationPass = 0;
        private int leftStationFail = 0;
        private int rightStationTotal = 0;
        private int rightStationPass = 0;
        private int rightStationFail = 0;

        // 统计UI控件
      private Panel panelStatistics;
private GroupBox gbLeftStationStats, gbRightStationStats;
        private Label lblLeftTotal, lblLeftTotalValue;
        private Label lblLeftPass, lblLeftPassValue;
        private Label lblLeftFail, lblLeftFailValue;
        private Label lblLeftYield, lblLeftYieldValue;
     private Label lblRightTotal, lblRightTotalValue;
        private Label lblRightPass, lblRightPassValue;
   private Label lblRightFail, lblRightFailValue;
  private Label lblRightYield, lblRightYieldValue;
        private Button btnClearLeftStats, btnClearRightStats, btnClearAllStats;

        /// <summary>
        /// 初始化统计面板
        /// </summary>
        private void InitializeStatisticsPanel()
        {
            // 创建主统计面板
   panelStatistics = new Panel
    {
     BackColor = Color.FromArgb(45, 45, 45),
                Dock = DockStyle.Fill,
            Padding = new Padding(10)
 };

       // 创建左工位统计组框
  gbLeftStationStats = new GroupBox
     {
           Text = G.Text("左工位统计"),
           ForeColor = Color.White,
          Font = new Font("微软雅黑", 11F, FontStyle.Bold),
     Location = new Point(10, 10),
      Size = new Size(320, 220)
         };

   // 创建右工位统计组框
     gbRightStationStats = new GroupBox
            {
      Text = G.Text("右工位统计"),
          ForeColor = Color.White,
     Font = new Font("微软雅黑", 11F, FontStyle.Bold),
     Location = new Point(10, 240),
                Size = new Size(320, 220)
            };

            // 初始化左工位统计标签
            InitializeStationLabels(gbLeftStationStats, 
        out lblLeftTotal, out lblLeftTotalValue,
  out lblLeftPass, out lblLeftPassValue,
                out lblLeftFail, out lblLeftFailValue,
   out lblLeftYield, out lblLeftYieldValue);

            // 初始化右工位统计标签
            InitializeStationLabels(gbRightStationStats,
    out lblRightTotal, out lblRightTotalValue,
       out lblRightPass, out lblRightPassValue,
      out lblRightFail, out lblRightFailValue,
        out lblRightYield, out lblRightYieldValue);

      // 创建清除按钮
            btnClearLeftStats = CreateButton(G.Text("清除左工位"), 10, 470, ClearLeftStationStats);
 btnClearRightStats = CreateButton(G.Text("清除右工位"), 120, 470, ClearRightStationStats);
      btnClearAllStats = CreateButton(G.Text("清除全部"), 230, 470, ClearAllStationStats);

  // 添加控件到面板
         panelStatistics.Controls.Add(gbLeftStationStats);
            panelStatistics.Controls.Add(gbRightStationStats);
        panelStatistics.Controls.Add(btnClearLeftStats);
            panelStatistics.Controls.Add(btnClearRightStats);
            panelStatistics.Controls.Add(btnClearAllStats);

     // 将统计面板添加到splitfunction.Panel1
// 需要在FormAuto_Load中调用AddStatisticsPanelToForm
 }

      /// <summary>
     /// 初始化单个工位的统计标签
        /// </summary>
        private void InitializeStationLabels(GroupBox groupBox,
            out Label lblTotal, out Label lblTotalValue,
  out Label lblPass, out Label lblPassValue,
     out Label lblFail, out Label lblFailValue,
      out Label lblYield, out Label lblYieldValue)
        {
            Font labelFont = new Font("微软雅黑", 10F, FontStyle.Regular);
        Font valueFont = new Font("微软雅黑", 11F, FontStyle.Bold);
    Color labelColor = Color.LightGray;
     Color valueColor = Color.White;

            int yStart = 30;
            int yOffset = 45;

       // 总数
         lblTotal = CreateLabel(G.Text("总数:"), 20, yStart, 80, 25, labelFont, labelColor);
          lblTotalValue = CreateLabel("0", 120, yStart, 180, 25, valueFont, valueColor);
            lblTotalValue.TextAlign = ContentAlignment.MiddleRight;

          // 良品数
      lblPass = CreateLabel(G.Text("良品:"), 20, yStart + yOffset, 80, 25, labelFont, labelColor);
        lblPassValue = CreateLabel("0", 120, yStart + yOffset, 180, 25, valueFont, Color.LightGreen);
         lblPassValue.TextAlign = ContentAlignment.MiddleRight;

        // 不良数
   lblFail = CreateLabel(G.Text("不良:"), 20, yStart + yOffset * 2, 80, 25, labelFont, labelColor);
    lblFailValue = CreateLabel("0", 120, yStart + yOffset * 2, 180, 25, valueFont, Color.LightPink);
            lblFailValue.TextAlign = ContentAlignment.MiddleRight;

    // 良率
            lblYield = CreateLabel(G.Text("良率:"), 20, yStart + yOffset * 3, 80, 25, labelFont, labelColor);
       lblYieldValue = CreateLabel("0.00%", 120, yStart + yOffset * 3, 180, 25, valueFont, Color.LightBlue);
            lblYieldValue.TextAlign = ContentAlignment.MiddleRight;

          // 添加到组框
         groupBox.Controls.AddRange(new Control[] {
     lblTotal, lblTotalValue, lblPass, lblPassValue,
           lblFail, lblFailValue, lblYield, lblYieldValue
         });
        }

   /// <summary>
        /// 创建标签控件
        /// </summary>
 private Label CreateLabel(string text, int x, int y, int width, int height, Font font, Color foreColor)
        {
            return new Label
    {
        Text = text,
    Location = new Point(x, y),
           Size = new Size(width, height),
  Font = font,
 ForeColor = foreColor,
   BackColor = Color.Transparent,
     AutoSize = false
      };
   }

     /// <summary>
        /// 创建按钮控件
        /// </summary>
        private Button CreateButton(string text, int x, int y, EventHandler clickHandler)
        {
    Button btn = new Button
       {
     Text = text,
     Location = new Point(x, y),
  Size = new Size(100, 30),
    Font = new Font("微软雅黑", 9F),
       BackColor = Color.FromArgb(70, 70, 70),
                ForeColor = Color.White,
     FlatStyle = FlatStyle.Flat
     };
          btn.FlatAppearance.BorderColor = Color.Gray;
  btn.Click += clickHandler;
     return btn;
        }

        /// <summary>
        /// 将统计面板添加到窗体
        /// </summary>
        private void AddStatisticsPanelToForm()
      {
  if (panelStatistics != null)
            {
   // 清除splitfunction.Panel1中可能已存在的统计面板
           foreach (Control ctrl in splitfunction.Panel1.Controls)
     {
           if (ctrl is Panel && ctrl.Name == "panelStatistics")
  {
      splitfunction.Panel1.Controls.Remove(ctrl);
         break;
    }
        }

      panelStatistics.Name = "panelStatistics";
       panelStatistics.Dock = DockStyle.Top;
     panelStatistics.Height = 520;
          splitfunction.Panel1.Controls.Add(panelStatistics);
     panelStatistics.BringToFront();
      }
        }

        /// <summary>
   /// 更新左工位统计数据（重载方法）
        /// </summary>
        /// <param name="index">测试序号</param>
        /// <param name="testName">测试名称</param>
   /// <param name="testResult">测试结果</param>
        public void UpdateLeftStationTest(int index, string testName, string testResult, bool updateStats)
        {
            UpdateLeftStationTest(index, testName, testResult);
    
            if (updateStats)
      {
   UpdateLeftStationStatistics(testResult);
    }
        }

        /// <summary>
        /// 更新右工位统计数据（重载方法）
        /// </summary>
        /// <param name="index">测试序号</param>
        /// <param name="testName">测试名称</param>
        /// <param name="testResult">测试结果</param>
        public void UpdateRightStationTest(int index, string testName, string testResult, bool updateStats)
 {
 UpdateRightStationTest(index, testName, testResult);
   
   if (updateStats)
            {
 UpdateRightStationStatistics(testResult);
        }
        }

        /// <summary>
        /// 更新左工位统计信息
        /// </summary>
        private void UpdateLeftStationStatistics(string testResult)
        {
            if (this.InvokeRequired)
            {
  this.Invoke(new Action(() => UpdateLeftStationStatistics(testResult)));
       return;
            }

    leftStationTotal++;
      
 if (testResult.Contains("PASS") || testResult.Contains("通过") || testResult.Contains("OK"))
            {
      leftStationPass++;
        }
            else if (testResult.Contains("FAIL") || testResult.Contains("失败") || testResult.Contains("NG"))
            {
  leftStationFail++;
            }

            UpdateLeftStationDisplay();
        }

        /// <summary>
        /// 更新右工位统计信息
     /// </summary>
        private void UpdateRightStationStatistics(string testResult)
      {
    if (this.InvokeRequired)
      {
this.Invoke(new Action(() => UpdateRightStationStatistics(testResult)));
     return;
            }

       rightStationTotal++;
  
            if (testResult.Contains("PASS") || testResult.Contains("通过") || testResult.Contains("OK"))
          {
     rightStationPass++;
         }
 else if (testResult.Contains("FAIL") || testResult.Contains("失败") || testResult.Contains("NG"))
            {
   rightStationFail++;
       }

         UpdateRightStationDisplay();
        }

    /// <summary>
        /// 更新左工位显示
        /// </summary>
        private void UpdateLeftStationDisplay()
    {
    if (lblLeftTotalValue != null)
            {
       lblLeftTotalValue.Text = leftStationTotal.ToString();
     lblLeftPassValue.Text = leftStationPass.ToString();
    lblLeftFailValue.Text = leftStationFail.ToString();
       
       double yield = leftStationTotal > 0 ? (leftStationPass * 100.0 / leftStationTotal) : 0;
  lblLeftYieldValue.Text = yield.ToString("F2") + "%";

      // 根据良率设置颜色
      if (yield >= 95)
       {
  lblLeftYieldValue.ForeColor = Color.LightGreen;
         }
else if (yield >= 85)
      {
         lblLeftYieldValue.ForeColor = Color.Yellow;
                }
        else
                {
      lblLeftYieldValue.ForeColor = Color.Red;
             }
            }
  }

        /// <summary>
   /// 更新右工位显示
     /// </summary>
        private void UpdateRightStationDisplay()
        {
   if (lblRightTotalValue != null)
 {
 lblRightTotalValue.Text = rightStationTotal.ToString();
         lblRightPassValue.Text = rightStationPass.ToString();
     lblRightFailValue.Text = rightStationFail.ToString();
         
     double yield = rightStationTotal > 0 ? (rightStationPass * 100.0 / rightStationTotal) : 0;
      lblRightYieldValue.Text = yield.ToString("F2") + "%";

  // 根据良率设置颜色
          if (yield >= 95)
       {
      lblRightYieldValue.ForeColor = Color.LightGreen;
           }
  else if (yield >= 85)
          {
 lblRightYieldValue.ForeColor = Color.Yellow;
           }
    else
   {
 lblRightYieldValue.ForeColor = Color.Red;
      }
         }
        }

        /// <summary>
        /// 清除左工位统计数据
        /// </summary>
        private void ClearLeftStationStats(object sender, EventArgs e)
     {
            if (MessageBox.Show(G.Text("确定要清除左工位统计数据吗？"), G.Text("确认"), 
                MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.Yes)
    {
         leftStationTotal = 0;
                leftStationPass = 0;
     leftStationFail = 0;
         UpdateLeftStationDisplay();
     ClearLeftStationTests();
         MyApp.GetInstance().Logger.WriteRecord(G.Text("左工位统计数据已清除"));
            }
        }

        /// <summary>
        /// 清除右工位统计数据
        /// </summary>
        private void ClearRightStationStats(object sender, EventArgs e)
        {
    if (MessageBox.Show(G.Text("确定要清除右工位统计数据吗？"), G.Text("确认"), 
    MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.Yes)
    {
     rightStationTotal = 0;
            rightStationPass = 0;
       rightStationFail = 0;
   UpdateRightStationDisplay();
ClearRightStationTests();
                MyApp.GetInstance().Logger.WriteRecord(G.Text("右工位统计数据已清除"));
            }
    }

   /// <summary>
        /// 清除所有工位统计数据
        /// </summary>
private void ClearAllStationStats(object sender, EventArgs e)
        {
          if (MessageBox.Show(G.Text("确定要清除所有统计数据吗？"), G.Text("确认"), 
MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.Yes)
     {
     leftStationTotal = 0;
     leftStationPass = 0;
leftStationFail = 0;
      rightStationTotal = 0;
      rightStationPass = 0;
                rightStationFail = 0;
      UpdateLeftStationDisplay();
        UpdateRightStationDisplay();
   ClearLeftStationTests();
    ClearRightStationTests();
  MyApp.GetInstance().Logger.WriteRecord(G.Text("所有工位统计数据已清除"));
            }
  }

        /// <summary>
        /// 获取左工位统计数据
        /// </summary>
        public (int total, int pass, int fail, double yield) GetLeftStationStatistics()
        {
        double yield = leftStationTotal > 0 ? (leftStationPass * 100.0 / leftStationTotal) : 0;
            return (leftStationTotal, leftStationPass, leftStationFail, yield);
        }

     /// <summary>
        /// 获取右工位统计数据
        /// </summary>
     public (int total, int pass, int fail, double yield) GetRightStationStatistics()
      {
  double yield = rightStationTotal > 0 ? (rightStationPass * 100.0 / rightStationTotal) : 0;
       return (rightStationTotal, rightStationPass, rightStationFail, yield);
      }
    }
}
